<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Shopping Cart</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <a href="/shop">Shop</a>
                        <span>Shopping Cart</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Shopping Cart Section Begin -->
<section class="shopping-cart spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="shopping__cart__table">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Size</th>
                                <th>Color</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each cartLists}}
                            <tr>
                                <td class="product__cart__item" tag="{{this.productPrice}}">
                                    <div class="product__cart__item__pic">
                                        <img src="{{this.productImage}}" alt="">
                                    </div>
                                    <div class="product__cart__item__text">
                                        <h6>{{this.productName}}</h6>
                                        <h5>${{this.productPrice}}</h5>
                                    </div>
                                </td>
                                <td class="quantity__item">
                                    <div class="quantity">
                                        <div class="pro-qty-2">
                                            <input type="text" value="{{this.quantity}}">
                                        </div>
                                    </div>
                                </td>
                                <td class="cart__size">
                                    <select id="select-size">
                                        {{#each this.sizes}}
                                        {{#ifEquals ../selectedSizeIndex this.index}}
                                        <option selected value="{{this.size}}">{{this.size}}</option>
                                        {{else}}
                                        <option value="{{this.size}}">{{this.size}}</option>
                                        {{/ifEquals}}
                                        {{/each}}
                                    </select>
                                </td>

                                <td class="cart__color">
                                    <select id="select-color">
                                        {{#each this.colors}}
                                        {{#ifEquals ../selectedColorIndex this.index}}
                                        <option selected value="{{this.colorId}}">{{this.colorText}}</option>
                                        {{else}}
                                        <option value="{{this.colorId}}">{{this.colorText}}</option>
                                        {{/ifEquals}}
                                        {{/each}}
                                    </select>
                                </td>
                                <td class="cart__close"><i class="fa fa-close" tag="{{this.id}}"></i></td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <div class="continue__btn">
                            <a href="/shop?page=1" class="custom_hover_bg_light_gray">Continue Shopping</a>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6 col-sm-6">
                        <div class="continue__btn update__btn ">
                            <a id="btn-update-cart" class="custom_hover_bg_light_black"><i class="fa fa-spinner"></i>
                                Update
                                cart</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="cart__discount">
                    <h6>Discount codes</h6>
                    <form action="#">
                        <input type="text" placeholder="Coupon code">
                        <button type="submit" class="custom_hover_bg_light_black">Apply</button>
                    </form>
                </div>
                <div class="cart__total">
                    <h6>Cart total</h6>
                    <ul>
                        <li>Subtotal <span>$ {{subtotal}}</span></li>
                        <li>Total <span>$ {{total}}</span></li>
                    </ul>
                    <a href="/shop/checkout" class="primary-btn custom_hover_bg_light_black">Proceed to checkout</a>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Shopping Cart Section End -->

{{!-- Start script --}}
<script>
    $(document).ready(function () {
        $('.cart__close i').click(function () {
            let id = parseInt($(this).attr('tag'));
            handleEventForCartClose(id);
        });

        $('#btn-update-cart').click(function () {
            handleEventForUpdateCart();
        });
    });

    function handleEventForCartClose(id) {
        // Get the current URL
        let currentURL = window.location.href;

        // Create a URL object
        let url = new URL(currentURL);
        let api = url.origin + '/shop/api/post/remove-cart';

        const formData = { id: id };
        $.ajax({
            url: api,
            method: "POST",
            data: formData,
            // Display data
            success: function (response) {
                Toastify({
                    text: response.message,
                    duration: 3000,
                    newWindow: true,
                    close: false,
                    gravity: "top", // `top` or `bottom`
                    position: "right", // `left`, `center` or `right`
                    stopOnFocus: true, // Prevents dismissing of toast on hover
                    style: {
                        width: "250px",
                        background: "linear-gradient(to right, #00b09b, #96c93d)",
                    },
                    onClick: function () { } // Callback after click
                }).showToast();

                removeRowFromTable(id);
                updateTotal();
            },
            error: function (error) {
                console.log("Error:", error);
            }
        });
    }

    function removeRowFromTable(id) {
        $(`tr:has(td.cart__close>i[tag="${id}"])`).remove();
    }

    function handleEventForUpdateCart() {
        let tableRows = $('.shopping__cart__table tbody tr');
        const formData = { cartLists: [] };

        for (let i = 0; i < tableRows.length; i++) {
            let id = $(tableRows[i]).find('.cart__close i').attr('tag');
            let size = parseFloat($(tableRows[i]).find('.cart__size ul li.selected').attr('data-value'));
            let color = $(tableRows[i]).find('.cart__color ul li.selected').attr('data-value');
            let quantity = parseInt($(tableRows[i]).find('.quantity__item input').val());
            if (isNaN(quantity) || quantity <= 0) {
                alert("Quantity is invalied");
                return;
            }

            cartList = {
                id: id,
                quantity: quantity,
                size: size,
                color: color,
            };

            formData.cartLists.push(cartList);
        }

        // Get the current URL
        let currentURL = window.location.href;

        // Create a URL object
        let url = new URL(currentURL);
        let api = url.origin + '/shop/api/post/update-cart';

        $.ajax({
            url: api,
            method: "POST",
            data: formData,
            // Display data
            success: function (response) {
                Toastify({
                    text: response.message,
                    duration: 3000,
                    newWindow: true,
                    close: false,
                    gravity: "top", // `top` or `bottom`
                    position: "right", // `left`, `center` or `right`
                    stopOnFocus: true, // Prevents dismissing of toast on hover
                    style: {
                        width: "250px",
                        background: "linear-gradient(to right, #00b09b, #96c93d)",
                    },
                    onClick: function () { } // Callback after click
                }).showToast();

                updateTotal();
            },
            error: function (error) {
                console.log("Error:", error);
            }
        });
    }

    function updateTotal() {
        let tableRows = $('.shopping__cart__table tbody tr');
        let total = 0;

        for (let i = 0; i < tableRows.length; i++) {
            let price = parseFloat($(tableRows[i]).find('.product__cart__item').attr('tag'));
            let quantity = parseInt($(tableRows[i]).find('.quantity__item input').val());

            total += price * quantity;
        }

        $('.cart__total ul li span').html(`$ ${total}`);
    }

</script>
{{!-- End script --}}